\documentclass[%
    12pt,
    bibliography=toc,
    listof=leveldown,% use section for the list headings
    oneside
]{book}
\usepackage[subpreambles=true]{standalone}

\usepackage[margin=2cm]{geometry}
\usepackage[table]{xcolor}
\usepackage[utf8]{inputenc}
\usepackage[english]{babel}
\usepackage{listings}
\usepackage[toc,page]{appendix}
\usepackage{tikz}
\usepackage[absolute,overlay]{textpos}
\usepackage{etoolbox}
\usepackage{pdfpages}
\usepackage{tabularx}
\usepackage{hyperref}
\usepackage{import}
\usepackage{amsmath}
\usepackage{cleveref}

% Chapter formatting
\usepackage{titlesec, blindtext, color}
\definecolor{gray75}{gray}{0.75}
\newcommand{\hsp}{\hspace{20pt}}
\titleformat{\chapter}[hang]{\Huge\bfseries}{\thechapter\hsp\textcolor{gray75}{\textbar}\hsp}{0pt}{\Huge\bfseries}
\titlespacing*{\chapter}{0pt}{-40pt}{30pt}

\input{./src/macros.tex}
\input{./src/listing.tex}

\begin{document}
\input titlepage

\frontmatter

\section*{Declaration of Originality}

I, Géza Csenger of Homerton College, being a candidate for Part II of the 
Computer Science Tripos, hereby declare that this dissertation and the work
described in it are my own work, unaided except as may be specified below, and
that the dissertation does not contain material that has already been used to
any substantial extent for a comparable purpose.

I, Géza Csenger of Homerton College,
am content for my dissertation to be made available to the students and staff
of the University. 

\vspace{1cm}
\textbf{Signed}

\vspace{1cm}
\textbf{Date}

\vspace{3cm}

\section*{Acknowledgements}

Hereby, I would like to say thanks to:
\begin{itemize}
    \item My project supervisor, \textbf{Prof. Alan Mycroft}, for his support
        and guidance
    \item My Director of Studies, \textbf{Dr John Fawcett}, for a \emph{lot} of
        things
    \item Friends and family without whom completing this work would have been
        impossible
\end{itemize}

\newpage

\chapter{Proforma}
\begin{tabularx}{\textwidth}{@{} ll @{}}
Candidate number & 2375C \\
Project title & Compiling algebraic effect handlers \\
Examination & Computer Science Tripos -- Part II, 2020 \\
Word Count & 10314 \\
Lines of Code & 6158
\footnote{Obtained with Visual Studio Code's \href{https://marketplace.visualstudio.com/items?itemName=uctakeoff.vscode-counter}{VS Code Counter} extension} \\
Page Count & 40 \\
Project Originator & The author \\
Supervisor & Professor Alan Mycroft \\
\end{tabularx}

\paragraph{Original aims of the Project}

The project had four core aims: to write an interpreter for Eff, to design a
byte code for Eff, to write a compiler from Eff to this byte code and to
implement a virtual machine interpreting the byte code. Additional goals were
to implement various optimisations for Eff, such as tail resumption optimisation
or minimising the copy overhead from the use of continuations.

\paragraph{Work completed}

A syntax-level Eff interpreter was implemented. A byte code for Eff (SHADEcode)
was designed. A compiler from Eff to SHADEcode was implemented as well as a
virtual machine (SHADE) interpreting SHADEcode. As far as I know, SHADE and
SHADEcode are the first virtual machine and byte code designed
\emph{specifically} for Eff. In the Evaluation chapter I compare the performance
of my Eff interpreter with the current official Eff interpreter and the
performance of the SHADE virtual machine with the performance of Multicore
OCaml (another compiled language with similar features to Eff).

\paragraph{Special difficulties}
None.

\tableofcontents

\newpage
\listoffigures
\listoftables
\lstlistoflistings

\mainmatter

\chapter{Introduction}
\import{sections/}{introduction}

\chapter{Preparation}
\import{sections/}{preparation}

\chapter{Implementation}
\import{sections/}{implementation}

\chapter{Evaluation}
\import{sections/}{evaluation}

\chapter{Conclusion}
\import{sections/}{conclusion}

\bibliography{bibliography}{}
\bibliographystyle{plain}

\appendix

\begin{appendices}
\renewcommand{\thepage}{\thechapter.\arabic{page}}

\chapter{Theory}
\label{app:theory}
\setcounter{page}{1}
\import{sections/}{eff-formally}

\begin{myfigure}[1]{t}{Compilation from IR to SHADE bytecode}{fig:compilation}
    $$ \interp{\irId\ x}_s^\gamma = \text{where\_is}\ (x, s, \gamma) $$
    $$ \interp{\irConst\ c} = \textbf{const } c $$
    $$ \interp{\irBox\ (t, v_1 \dots v_n)}_s ^ \gamma = \interp{v_n}_s^\gamma; \vmPush; \interp{v_{n-1}}_{s+1}^\gamma; \vmPush; \dots \interp{v_1}_{s+n-1}^\gamma; \vmMakeBox{t}{n} $$
    $$ \underbrace{\interp{\irFun\ (x, body)}_s ^\gamma }_f = \text{fvs-to-stack} (s, \gamma, f); \vmMakeClosure{N}{L} $$
    $$ \underbrace{\interp{\irHandler\ (v, es, f)}_s^\gamma}_h = \text{fvs-to-stack} (s, \gamma, h); \vmMakeHlosure{N}{L_v}{L_f}{L_{e_1}, L_{e_2}, \dots} $$
    $$ \interp{\irVal\ v}_s ^ \gamma =  \interp{v}_s ^ \gamma $$
    $$ \interp{\irIf\ (v, e_1, e_2)}_s ^ \gamma = \vmBranchIfNot\ L_\text{false}; \interp{e_1}_s^\gamma; \vmJump\ L_\text{exit}; \vmLabel\ L_\text{false}; \interp{e_2}_s^\gamma; \vmLabel\ L_\text{exit} $$
    $$ \interp{\irLetIn\ (x, e_1, e_2)}_s^\gamma = \interp{e_1}_s^\gamma; \vmPush; \interp{e_2}_{s+1}^{\gamma[x \mapsto s]} $$
    $$ \interp{\irLetRecIn\ (f, x, body, e)}_s^\gamma = \text{fvs-to-stack}(f, x, body, s, \gamma); \vmMakeClosure{N}{L}; \vmPush; \interp{e}_{s+1}^{\gamma[f \mapsto s]} $$
    $$ \interp{\irPerform\ (id, v)} = \interp{v}_s ^ \gamma; \vmThrow\ id $$
    $$ \interp{\irWithHandle\ (h, e)}_s ^ \gamma = \interp{h}_s ^ \gamma; \vmPush; \text{fvs-to-stack}(e, s, \gamma); \vmMakeClosure{N}{L}; \shCast $$
    $$ \interp{\irBinOp\ (\mathtt{op}, v_1, v_2} = \interp{v_1}_s ^ \gamma; \vmPush; \interp{v_2}_{s+1}^\gamma; \text{instr-of}(\mathtt{op}) $$
    $$ \interp{\irFunApp\ (v_1, v_2)} = \interp{v_1}_s ^ \gamma; \vmPush; \interp{v_2}_{s+1} ^ \gamma; \vmApply $$
    $$ \interp{\irGetField\ (n, v)}_s ^ \gamma = \interp{v}_s ^ \gamma; \vmGetField{n} $$
    $$ \interp{\irListHead\ v}_s ^ \gamma = \interp{v}_s ^ \gamma; \vmListHead $$
    $$ \interp{\irListTail\ v}_s ^ \gamma = \interp{v}_s ^ \gamma ; \vmListTail $$
\end{myfigure}

\chapter{Code}
\label{sec:code-snippets}
\setcounter{page}{1}

\mylisting{caml}
{Unwinding of the K component in the CEK machine}
{lst:cek-unwind-ocaml}
{code_examples/cek_unwind.ml}

\chapter{Software Engineering}

\begin{figure}
    \centering
    \includegraphics[width=35em]{screenshots/documentation.png}

    \caption[Documentation]{Writing documentation helps both with structuring a developer's own
    thoughts and helps new contributors accommodate to a new codebase}
    \label{fig:app-screenshot-documentation}
\end{figure}

\begin{figure}
    \centering
    \includegraphics[width=35em]{screenshots/tests.png}

    \caption[Unit tests]{Tests help to guarantee some correctness properties of the software}
    \label{fig:app-screenshot-tests}
\end{figure}

\begin{figure}
    \centering
    \includegraphics[width=35em]{screenshots/webserver_log.png}
    
    \caption{Excerpt from the webserver's log}
    \label{fig:app-screenshot-webserver-log}
\end{figure}

\begin{figure}
    \centering
    \includegraphics[width=35em]{screenshots/webserver_hello_world.png}

    \caption{The output of a Hello World webserver implemented using effect handlers}
    \label{fig:app-screenshot-webserver-hello-world}

\end{figure}

\chapter{Measurement results}
% TODO: copy raw data

\chapter{Project Proposal}
\label{project-proposal}
\setcounter{page}{1}
The project proposal starts on the next page.
\includepdf[pages=-]{sections/proposal.pdf}

\end{appendices}

\end{document}
